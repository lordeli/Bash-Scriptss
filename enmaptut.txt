NMAP Tutorial and Examples
This is the second part of this article where I’ll show you some examples, use cases and techniques of using nmap in practical penetration testing and security assessment engagements.


#1 My personal favourite way of using Nmap
Whenever I start a penetration test, I follow the steps below with nmap.

Step 1a: Host Discovery with well knows ports

nmap -PS21-25,80,88,111,135,443,445,3306,3389,8000-8080 -T4 -oA hostdiscovery 100.100.100.0/24

The above will perform host discovery to identify live hosts using some well-known ports (21-25, 80, 443 etc). The output will be 3 files (gnmap, xml, txt) with filename “hostdiscovery”. We assume the target network range is 100.100.100.0/24

With the above technique, if at least one of the above TCP ports is open on a target host in the IP range then nmap will know that the host is alive.

The above technique is efficient if you are scanning a large public IP range and you know there is a firewall in front and that only limited ports are visible because of the firewall. The above ports will most probably be visible on public hosts.

Step 1b: Host Discovery with ICMP

nmap -PE -oA hostdiscovery 192.168.1.0/24

The above is a variation of previous step (Step 1a) whereby nmap sends ICMP packets to discover live hosts.

This technique is effective if you are scanning from the same LAN subnet as the target range and there is no firewall in front of the hosts and also ICMP ping is not blocked from the hosts.

The end result is the same as the previous step. Live hosts will be recorded in filename “hostdiscovery” with several ports marked as open for each IP address.

Step 2: Filter Above Files to Create a Clean Live Hosts Lists

The filename created above (“hostdiscovery”) will contain hosts with open ports. We can filter all IP addresses in the file above that have at least one open port and create a clean list of live host IPs.

I use the linux “awk” command for this task as shown below:

# awk ‘/open/{print $2}’ hostdiscovery.gnmap > livehosts.txt

From Step 1 before, there are three files created and one of them is a greppable format file with extension gnmap  (“hostdiscovery.gnmap”).


We run awk to search for open ports in that file and then redirect the output to another file “livehosts.txt”. This file will only contain a list of IP addresses that correspond to live hosts in the target network.

MORE READING:  12 Best Open Source Firewalls Comparable to Commercial Solutions
Step 3: Perform Full Port Scan using the Live Hosts List

Now after identifying the live hosts in the whole subnet, we can perform full port scan with nmap towards these hosts only.

By doing this, we managed to be more efficient and perform scans faster than doing full port scan on the whole target range from the beginning.

nmap -p- -Pn -sS -A -T4 -iL livehosts.txt -oA fullscan

-p- : This scans all ports

-Pn : Do not perform host discovery again

-sS : Perform TCP SYN scan

-A : This combines OS detection, service version detection, script scanning and traceroute

-T4 : Pretty fast and accurate scanning

-iL livehosts.txt : Scan the IPs contained in file “livehosts.txt”

-oA : Export the results in file “fullscan”

#2 Scan network for EternalBlue (MS17-010) Vulnerability
In 2017 a huge zero-day vulnerability in Windows SMB was leaked to the public with the name “EternalBlue” (reference code MS17-010 from Microsoft). This is a critical risk vulnerability that allows easy compromise of remote Windows machines.

You must scan your networks to find out if you have Windows machines that are not patched for this and the following nmap script is very useful for this task.

nmap -Pn -p445 --script=smb-vuln-ms17-010 192.168.1.0/24 -oN eternalblue-scan.txt
The command above will scan the whole Class C network 192.168.1.0/24 on port 445 (SMB port) for the EternalBlue vulnerability and will write the results in file “eternalblue-scan.txt”

#3 Find HTTP servers and then run nikto against them
The following scans the target range (100.100.100.0/24) for HTTP servers (ports 80 and 443) and then pipes the result to “Nikto” for further HTTP scans. Nikto is an open source tool for identifying well known HTTP vulnerabilities.

nmap -p80,443 100.100.100.0/24 -oG – | nikto.pl -h –



#4 Find Servers running Netbios (ports 137,139, 445)
nmap -sV -v -p 137,139,445 192.168.1.0/24

#5 Find Geo Location of a specific IP address
The following command uses geolocation script “ip-geolocation-ipinfodb” to find the geographic location of a specific IP address. To use the above script you need to create a free account at https://ipinfodb.com/register.php and get an API key to use in the command as shown below (in script-args).

nmap --script=ip-geolocation-ipinfodb --script-args=ip-geolocation-ipinfodb.apikey=[APIKEY] 8.8.8.8
Nmap scan report for google-public-dns-a.google.com (8.8.8.8)
Host is up (0.0097s latency).
Not shown: 998 filtered ports
PORT    STATE SERVICE
53/tcp  open  domain
443/tcp open  https
Host script results:

| ip-geolocation-ipinfodb:
| 8.8.8.8
|   coordinates (lat,lon): 37.406,-122.079
|_  city: Mountain View, California, United States

#6 Detect if a Website is protected by WAF
A WAF (Web Application Firewall) can be a software or hardware device in front of webservers to protect from HTTP web application attacks.

The following command uses a script to detect if the target website is protected by a Web Application Firewall (WAF). The http-waf-detect script uses two arguments to try the tool’s built-in attack vectors for evaluating if the target web domain is protected by a WAF.

# nmap -p80,443 --script http-waf-detect --script-args="http-waf-detect.aggro,http-waf-detect.detectBodyChanges" www.networkstraining.com
Nmap scan report for www.networkstraining.com (104.18.38.202)
Host is up (0.011s latency).
PORT    STATE SERVICE
80/tcp  open  http
443/tcp open  https
| http-waf-detect: IDS/IPS/WAF detected:
|_www.networkstraining.com:443/?p4yl04d=hostname%00



#7 Find well known vulnerabilities related to an open port
Let’s say you have scanned a target host and found several open services/ports running on the host. With nmap you can query public vulnerability databases to find out if there are any known published vulnerabilities related to the services running.

Step 1:

First you need to download the “nmap-vulners” script from Git and place it under the script directory of nmap:

# cd /pentest/vulnerability-analysis/nmap/scripts (or whatever the scripts directory is)

#  git clone https://github.com/vulnersCom/nmap-vulners.git

Step 2:

Since the script needs to know the exact version of the remote scanned service, you must use the -sV key when using the vulners script:

# nmap -Pn -sV -p80 --script=vulners scanme.nmap.org
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.7 ((Ubuntu))
|_http-server-header: Apache/2.4.7 (Ubuntu)
| vulners:
|   cpe:/a:apache:http_server:2.4.7:
|       CVE-2017-7679           7.5             https://vulners.com/cve/CVE-2017-7679
|       CVE-2018-1312           6.8             https://vulners.com/cve/CVE-2018-1312
|       CVE-2014-0226           6.8             https://vulners.com/cve/CVE-2014-0226
|       CVE-2017-15715          6.8             https://vulners.com/cve/CVE-2017-15715
|       CVE-2017-9788           6.4             https://vulners.com/cve/CVE-2017-9788
|       CVE-2013-6438           5.0             https://vulners.com/cve/CVE-2013-6438
|       CVE-2014-0231           5.0             https://vulners.com/cve/CVE-2014-0231
|       CVE-2017-9798           5.0             https://vulners.com/cve/CVE-2017-9798
|       CVE-2016-8743           5.0             https://vulners.com/cve/CVE-2016-8743
|       CVE-2017-15710          5.0             https://vulners.com/cve/CVE-2017-15710
|       CVE-2016-0736           5.0             https://vulners.com/cve/CVE-2016-0736
|       CVE-2014-3523           5.0             https://vulners.com/cve/CVE-2014-3523
|       CVE-2016-2161           5.0             https://vulners.com/cve/CVE-2016-2161
|       CVE-2018-17199          5.0             https://vulners.com/cve/CVE-2018-17199
|       CVE-2014-0098           5.0             https://vulners.com/cve/CVE-2014-0098
|       CVE-2016-4975           4.3             https://vulners.com/cve/CVE-2016-4975
|       CVE-2014-0117           4.3             https://vulners.com/cve/CVE-2014-0117
|       CVE-2014-8109           4.3             https://vulners.com/cve/CVE-2014-8109
|       CVE-2015-3185           4.3             https://vulners.com/cve/CVE-2015-3185
|       CVE-2014-0118           4.3             https://vulners.com/cve/CVE-2014-0118
|       CVE-2018-1283           3.5             https://vulners.com/cve/CVE-2018-1283
|_      CVE-2016-8612           3.3             https://vulners.com/cve/CVE-2016-8612